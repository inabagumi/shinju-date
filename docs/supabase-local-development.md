# Supabaseローカル開発環境ガイド

このドキュメントでは、SHINJU DATEプロジェクトにおけるSupabaseローカル開発環境の詳細な設定と使用方法について説明します。

## 目次

1. [概要](#概要)
2. [アーキテクチャ](#アーキテクチャ)
3. [初期セットアップ](#初期セットアップ)
4. [データベースマイグレーション](#データベースマイグレーション)
5. [データ同期](#データ同期)
6. [トラブルシューティング](#トラブルシューティング)

## 概要

このプロジェクトでは、OSS版Supabaseを使用してローカル開発環境を構築しています。これにより、以下のメリットが得られます：

- **安全性**: 本番データを誤って変更・削除するリスクがゼロ
- **オフライン開発**: インターネット接続なしでも開発可能
- **高速**: ローカルで動作するため、レスポンスが高速
- **バージョン管理**: スキーマ変更をGitで管理
- **テスト**: 本番に近いデータでテスト可能

## アーキテクチャ

ローカル環境では、以下のSupabaseコンポーネントがDockerコンテナとして起動します：

- **PostgreSQL** (port 54322): メインデータベース
- **PostgREST** (port 54321): RESTful API
- **GoTrue** (port 54324): 認証サーバー
- **Realtime** (port 54325): リアルタイム通信
- **Storage** (port 54326): ファイルストレージ
- **Supabase Studio** (port 54323): 管理UI
- **Inbucket** (port 54324): メールテスト用サーバー

## 初期セットアップ

### 1. Dev Containerの起動

GitHub CodespacesまたはVS Code Dev Containersを使用してプロジェクトを開きます。

Dev Containerは自動的に以下を実行します：
- Supabase CLIのインストール
- Dockerのセットアップ
- 依存関係のインストール
- Supabaseの起動

### 2. Supabase設定の確認

`supabase/config.toml`ファイルには、ローカル環境の設定が記述されています。必要に応じてポート番号などを変更できます。

### 3. 初回スキーマのセットアップ

**本番環境からスキーマをダンプ（初回のみ）：**

```bash
# Supabase CLIでログイン
supabase login

# スキーマをダンプ
supabase db dump --project-ref YOUR_PROJECT_ID --schema public --file supabase/migrations/00000000000000_initial_schema.sql
```

このファイルには以下が含まれます：
- テーブル定義
- インデックス
- 外部キー制約
- Row Level Security (RLS) ポリシー
- 関数とトリガー
- ビュー

**注意**: データは含めず、スキーマのみをダンプしてください。

### 4. マイグレーションの適用

```bash
supabase db reset
```

このコマンドは：
1. ローカルデータベースをリセット
2. すべてのマイグレーションを適用
3. `supabase/seed.sql`のシードデータを投入

## データベースマイグレーション

### 新しいマイグレーションの作成

```bash
supabase migration new add_new_feature
```

生成されたファイル（`supabase/migrations/YYYYMMDDHHMMSS_add_new_feature.sql`）にSQLを記述します。

### マイグレーションの例

```sql
-- テーブルの作成
CREATE TABLE public.new_table (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- RLSの有効化
ALTER TABLE public.new_table ENABLE ROW LEVEL SECURITY;

-- RLSポリシーの作成
CREATE POLICY "Allow public read access" ON public.new_table
    FOR SELECT USING (true);
```

### マイグレーションの適用

ローカル環境に適用：
```bash
supabase db reset
```

本番環境に適用：
```bash
supabase db push --project-ref YOUR_PROJECT_ID
```

### マイグレーションのロールバック

Supabaseはロールバック機能を直接サポートしていないため、新しいマイグレーションで変更を元に戻す必要があります。

```bash
supabase migration new rollback_feature
```

## データ同期

### データのエクスポート（本番→ローカル）

#### 自動エクスポート（推奨）

GitHub Actionsワークフロー（`.github/workflows/database-backup.yml`）が毎日自動的に実行され、本番データをGCS/S3にバックアップします。

#### 手動エクスポート

```bash
# 環境変数を設定
export SUPABASE_PROJECT_ID=your-project-id
export SUPABASE_DB_PASSWORD=your-password

# クラウドストレージを使用する場合
export UPLOAD_TO_CLOUD=true
export GCS_BUCKET=your-bucket-name  # または S3_BUCKET

# エクスポート実行
pnpm db:export
```

出力ファイル：`supabase/data-exports/production_data_YYYYMMDD_HHMMSS.sql.gz`

#### エクスポートするテーブルのカスタマイズ

`scripts/export-production-data.sh`の`TABLES_TO_EXPORT`配列を編集します：

```bash
TABLES_TO_EXPORT=(
    "public.videos"
    "public.channels"
    "public.tags"
    # 個人情報を含むテーブルは除外
)
```

### データのインポート（本番→ローカル）

```bash
pnpm db:import
```

このコマンドは：
1. GCS/S3から最新のバックアップをダウンロード（設定されている場合）
2. ファイルを解凍
3. ローカルSupabaseにインポート

#### 特定のファイルをインポート

```bash
IMPORT_FILENAME=production_data_20250120_020000.sql.gz pnpm db:import
```

#### ローカルファイルからインポート

```bash
# GCS/S3が設定されていない場合、自動的にローカルファイルを使用
pnpm db:import
```

### データのクリーンアップ

個人情報や機密情報を含むデータをインポートした場合は、使用後に必ず削除してください：

```bash
supabase db reset
```

## トラブルシューティング

### Supabaseが起動しない

```bash
# ログを確認
supabase status
docker ps

# 完全リセット
supabase stop --no-backup
docker system prune -f
supabase start
```

### マイグレーションが失敗する

```bash
# エラーメッセージを確認
supabase db reset

# 問題のあるマイグレーションファイルを修正
# 再度実行
supabase db reset
```

### ポート競合

`supabase/config.toml`でポート番号を変更：

```toml
[api]
port = 54321  # 別のポートに変更

[studio]
port = 54323  # 別のポートに変更
```

変更後、Supabaseを再起動：

```bash
supabase stop
supabase start
```

### データベース接続エラー

```bash
# 接続情報を確認
supabase status

# データベースURLを取得
DB_URL=$(supabase status | grep "DB URL" | awk '{print $3}')
echo $DB_URL

# 接続テスト
psql $DB_URL -c "SELECT version();"
```

### メモリ不足

Supabaseは複数のDockerコンテナを起動するため、メモリが不足する場合があります。

Dev Containerの`.devcontainer/devcontainer.json`で最小要件を確認：

```json
"hostRequirements": {
  "cpus": 4,
  "memory": "8gb",
  "storage": "32gb"
}
```

## セキュリティのベストプラクティス

### 本番データの取り扱い

1. **個人情報を含むテーブルは除外**: エクスポートスクリプトで明示的に指定
2. **データの暗号化**: クラウドストレージでは暗号化を有効化
3. **アクセス制御**: バックアップファイルへのアクセスを制限
4. **定期的な削除**: 古いローカルデータは定期的に削除

### シークレットの管理

- `.env`ファイルは`.gitignore`に追加済み
- 本番の認証情報はGitHub Secretsで管理
- ローカル環境では別の認証情報を使用

### RLSポリシーのテスト

ローカル環境でRLSポリシーを十分にテストしてから本番環境に適用してください：

```sql
-- テストユーザーとしてクエリを実行
SET ROLE postgres;
SET LOCAL ROLE authenticated;
SET LOCAL request.jwt.claims TO '{"sub": "test-user-id"}';

-- クエリを実行してRLSをテスト
SELECT * FROM your_table;
```

## 参考資料

- [Supabase CLI ドキュメント](https://supabase.com/docs/guides/cli)
- [Supabase ローカル開発](https://supabase.com/docs/guides/cli/local-development)
- [PostgreSQL ドキュメント](https://www.postgresql.org/docs/)
- [Row Level Security (RLS)](https://supabase.com/docs/guides/auth/row-level-security)
