name: CI

on:
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]

env:
  # renovate: datasource=npm depName=corepack
  COREPACK_VERSION: 0.31.0
  # renovate: datasource=node-version depName=node
  NODE_VERSION: 22.13.1
  # renovate: datasource=github-releases depName=astral-sh/uv
  UV_VERSION: 0.9.5

jobs:
  # Install dependencies job (shared cache for all Node.js jobs)
  install:
    name: Install Dependencies
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    env:
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2
      - name: Enable Corepack
        run: |
          npm install -g corepack@${COREPACK_VERSION}
          corepack enable
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

  # Matrix job for all unit tests (Node.js packages + Python)
  test:
    name: Test (${{ matrix.package.name }})
    runs-on: ubuntu-24.04
    needs: install
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        package:
          # Node.js packages with tests (excluding UI browser tests)
          - name: "@shinju-date/composable-fetch"
            language: "node"
          - name: "@shinju-date/health-checkers"
            language: "node"
          - name: "@shinju-date/helpers"
            language: "node"
          - name: "@shinju-date/logger"
            language: "node"
          - name: "@shinju-date/msw-handlers"
            language: "node"
          - name: "@shinju-date/temporal-fns"
            language: "node"
          - name: "@shinju-date/youtube-api-client"
            language: "node"
          - name: "@shinju-date/youtube-scraper"
            language: "node"
          # Node.js apps with unit tests
          - name: "@shinju-date/admin"
            language: "node"
          - name: "@shinju-date/batch"
            language: "node"
          - name: "@shinju-date/web"
            language: "node"
          # Python app
          - name: "@shinju-date/insights"
            language: "python"
            path: "./apps/insights"
    env:
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      # Node.js setup
      - name: Enable Corepack
        if: matrix.package.language == 'node'
        run: |
          npm install -g corepack@${COREPACK_VERSION}
          corepack enable

      - name: Setup Node.js
        if: matrix.package.language == 'node'
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - name: Install Node.js dependencies
        if: matrix.package.language == 'node'
        run: pnpm install --frozen-lockfile

      # Node.js test execution
      - name: Run Node.js tests
        if: matrix.package.language == 'node'
        run: pnpm test --filter ${{ matrix.package.name }}

      # Python setup
      - name: Setup uv
        if: matrix.package.language == 'python'
        uses: astral-sh/setup-uv@v7
        with:
          version: ${{ env.UV_VERSION }}

      - name: Setup Python
        if: matrix.package.language == 'python'
        run: uv python install
        working-directory: ${{ matrix.package.path }}

      - name: Install Python dependencies
        if: matrix.package.language == 'python'
        run: uv sync --extra dev
        working-directory: ${{ matrix.package.path }}

      # Python test execution
      - name: Run Python tests
        if: matrix.package.language == 'python'
        run: uv run poe test
        working-directory: ${{ matrix.package.path }}

  # Lint job for Node.js and Python
  lint:
    name: Lint
    runs-on: ubuntu-24.04
    needs: install
    permissions:
      contents: read
    env:
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      # Node.js linting
      - name: Enable Corepack
        run: |
          npm install -g corepack@${COREPACK_VERSION}
          corepack enable

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Run Node.js lint
        run: pnpm check

      # Python linting
      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          version: ${{ env.UV_VERSION }}

      - name: Setup Python
        run: uv python install
        working-directory: ./apps/insights

      - name: Install Python dependencies
        run: uv sync --extra dev
        working-directory: ./apps/insights

      - name: Run Python lint
        run: uv run poe lint
        working-directory: ./apps/insights

      - name: Check Python formatting
        run: uv run poe format-check
        working-directory: ./apps/insights

  # Build job for Node.js
  build:
    name: Build (Node.js)
    runs-on: ubuntu-24.04
    needs: install
    permissions:
      contents: read
    env:
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Enable Corepack
        run: |
          npm install -g corepack@${COREPACK_VERSION}
          corepack enable

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - run: pnpm build --filter=!@shinju-date/admin --filter=!@shinju-date/batch --filter=!@shinju-date/web

  # E2E tests (including UI browser tests)
  e2e:
    name: E2E Tests (${{ matrix.target.name }})
    runs-on: ubuntu-24.04
    needs: [test, build]
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        target:
          # App E2E tests
          - name: "web"
            type: "app"
          - name: "admin"
            type: "app"
          - name: "batch"
            type: "app"
          # UI package browser tests
          - name: "ui"
            type: "package"
    env:
      TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
      TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Enable Corepack
        run: |
          npm install -g corepack@${COREPACK_VERSION}
          corepack enable

      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      # Build dependencies for apps
      - name: Build dependencies (apps)
        if: matrix.target.type == 'app'
        run: |
          pnpm build --filter=@shinju-date/msw-handlers
          pnpm build --filter=@shinju-date/${{ matrix.target.name }}^...

      # Get Playwright version for apps
      - name: Get Playwright version (apps)
        if: matrix.target.type == 'app'
        id: playwright-version-app
        run: |
          PLAYWRIGHT_VERSION=$(cd apps/${{ matrix.target.name }} && pnpm exec playwright --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "Playwright version for ${{ matrix.target.name }}: $PLAYWRIGHT_VERSION"

      # Get Playwright version for packages
      - name: Get Playwright version (packages)
        if: matrix.target.type == 'package'
        id: playwright-version-pkg
        run: |
          PLAYWRIGHT_VERSION=$(pnpm --filter @shinju-date/${{ matrix.target.name }} exec playwright --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT
          echo "Playwright version for @shinju-date/${{ matrix.target.name }}: $PLAYWRIGHT_VERSION"

      # Cache Playwright browsers
      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-e2e-${{ matrix.target.name }}-${{ matrix.target.type == 'app' && steps.playwright-version-app.outputs.version || steps.playwright-version-pkg.outputs.version }}-${{ runner.os }}

      # Install Playwright browsers for apps
      - name: Install Playwright browsers (apps)
        if: matrix.target.type == 'app' && steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd apps/${{ matrix.target.name }} && pnpm exec playwright install --with-deps chromium

      # Install Playwright browsers for packages
      - name: Install Playwright browsers (packages)
        if: matrix.target.type == 'package' && steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          PACKAGE_PATH=$(pnpm list --filter @shinju-date/${{ matrix.target.name }} --depth=-1 --parseable | head -n1)
          cd "$PACKAGE_PATH"
          pnpm exec playwright install --with-deps chromium

      # Run E2E tests for apps
      - name: Run E2E tests (apps)
        if: matrix.target.type == 'app'
        run: cd apps/${{ matrix.target.name }} && pnpm exec playwright test
        env:
          CI: true

      # Run browser tests for packages
      - name: Run browser tests (packages)
        if: matrix.target.type == 'package'
        run: pnpm test --filter @shinju-date/${{ matrix.target.name }}
        env:
          CI: true

      # Upload Playwright Report
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: playwright-report-${{ matrix.target.name }}
          path: |
            apps/${{ matrix.target.name }}/playwright-report/
            packages/${{ matrix.target.name }}/playwright-report/
          retention-days: 30

  # Summary job - this is the only required status check
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-24.04
    needs: [test, lint, build, e2e]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Test job failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint job failed"
            exit 1
          fi
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "Build job failed"
            exit 1
          fi
          if [ "${{ needs.e2e.result }}" != "success" ]; then
            echo "E2E job failed"
            exit 1
          fi
          echo "All jobs passed successfully!"
