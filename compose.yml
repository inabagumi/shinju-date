# Docker Compose configuration for SHINJU DATE development services
# This file contains the backing services needed for local development.
# Supabase services are managed by the Supabase CLI (`supabase start`).

services:
  # Redis for caching and session management
  redis:
    image: redis:8.4.0-bookworm@sha256:3906b477e4b60250660573105110c28bfce93b01243eab37610a484daebceb04
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # Redis HTTP API (Upstash compatible)
  serverless-redis-http:
    image: hiett/serverless-redis-http:0.0.10@sha256:65128347949bca511e448fd7238780d624573d74c22b79155a7563db19e9b678
    env_file:
      - ./config/dev-secrets.env
    ports:
      - "8079:80"
    environment:
      # Secrets loaded from env_file (./config/dev-secrets.env): SRH_TOKEN
      SRH_MODE: env
      SRH_CONNECTION_STRING: "redis://redis:6379"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:80/"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

volumes:
  redis-data:
