# Docker Compose configuration for Dev Container
# This runs alongside the main dev container and provides additional services

services:
  app:
    image: mcr.microsoft.com/devcontainers/typescript-node:4-24-bookworm
    volumes:
      - ../..:/workspaces:cached
    command: sleep infinity
    depends_on:
      redis:
        condition: service_healthy
      serverless-redis-http:
        condition: service_healthy

  redis:
    image: redis:8.4.0-bookworm
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  serverless-redis-http:
    image: hiett/serverless-redis-http:0.0.10
    ports:
      - "8079:80"
    environment:
      SRH_MODE: env
      SRH_TOKEN: local_development_token
      SRH_CONNECTION_STRING: "redis://redis:6379"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost/"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

volumes:
  redis-data:
